#!/usr/bin/python
# -*- coding: UTF-8 -*-
 
import xml.sax
import json
import io
 
class premissionXmlHandler( xml.sax.ContentHandler ):
   def __init__(self):
      self.premissions = []
      self.count = 0
 
   # 元素开始事件处理
   def startElement(self, tag, attributes):
      self.CurrentData = tag
      if(tag == 'tr'):
         self.count = 0
      if(tag == 'span'):
         self.count = self.count + 1
      #print("startElement: ", tag, attributes, self.count)
 
   # 元素结束事件处理
   def endElement(self, tag):
      #print("endElement: ", tag)
      #self.CurrentData = ""
      pass
 
   # 内容事件处理
   def characters(self, content):
      #print("characters: ", content, self.count)
      if self.count == 2:
         self.premissions.append(content)
         #print("characters", content)
         self.count = 0

   def getPremissions(self):
      return self.premissions



def extractPermissionsDict():
   # 创建一个 XMLReader
   parser = xml.sax.make_parser()
   # turn off namepsaces
   parser.setFeature(xml.sax.handler.feature_namespaces, 0)
 
   # 重写 ContextHandler
   Handler = premissionXmlHandler()
   parser.setContentHandler( Handler )
   
   parser.parse("Manifest.permission  _  Android Developers.html")

   premissions = Handler.getPremissions()
   values = extractPermissionValue()

   print(premissions)
   print(len(premissions))
   print(len(values))
   pres = {
      "reference": "https://developer.android.com/reference/android/Manifest.permission",
      "premissions": premissions,
      "values": values
   }
   with open("permissions.json", "w") as f:
        json.dump(pres, f, indent=4)


def extractPermissionValue():
   file = "Manifest.permission  _  Android Developers_total.html"
   schema = "Constant Value:"
   end_schema = "</p>"
   values = []
   with open(file, encoding = "UTF-8") as f:
   #f = io.open(file)   
      lines = f.read()
      pos = 0
      try:
         while True:
            pos = lines.index(schema, pos) + len(schema)
            end = lines.index(end_schema, pos)
            permission_value = lines[pos:end].strip(" \n")[1:-1]
            values.append(permission_value)
      except Exception as e:
         pass
   return values

if ( __name__ == "__main__"):
   extractPermissionsDict()
   #extractPermissionValue()
