import os
import json
from random import shuffle
import traceback
import hashlib

from tools.api_parser import API_PARSER 
from tools.string_parser import STRING_PARSER

def save_json(data, file_name):
    dir_name = os.path.dirname(file_name)
    if not os.path.isdir(dir_name):
        os.makedirs(dir_name)
    with open(file_name, 'w') as f:
        json.dump(data, f, indent=4)

def load_json(file_name):
    with open(file_name, 'r') as f:
        return json.load(f)

#direct_root 是apk文件所在的直接文件夹
def yield_app_paths(direct_root, print_path = True):
    cnt = 1
    for app in os.listdir(direct_root):
        app_abs_path = os.path.join(direct_root, app)
        if (not (app.endswith(".json") or app.endswith(".txt") or app.endswith(".tar"))) and os.path.isfile(app_abs_path):
            if print_path:
                print("app idx: ", cnt, "app_path: ", app_abs_path)
            #计数api在app中的出现次数，一个api在一个app中出现多次，累加多次
            yield app
            cnt += 1


#root 是apk文件所在的文件夹, 文件夹下的子文件夹才有apk
def yield_app_paths2(root, print_path = True):
    cnt = 1
    for sub_root, dirs, apps in os.walk(root):
        for app in apps:
            app_abs_path = os.path.join(sub_root, app)
            if "API-Intent-Traffic" in sub_root:
                continue
            if (not (app.endswith(".json") or app.endswith(".txt") or app.endswith(".tar") or app.endswith(".zip") or app.endswith(".csv"))) and os.path.isfile(app_abs_path):
                if print_path:
                    print("app idx: ", cnt, "app_path: ", app_abs_path)
                yield sub_root, app
                cnt += 1



def sha256(fname):
    """
    Method to calculate the SHA256 hash of a file
    :param fname: Path to file
    :return: SHA256 of the input file
    """
    hash_num = hashlib.sha256()
    with open(fname, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            hash_num.update(chunk)
    return hash_num.hexdigest()


if __name__ == '__main__':
    #path = "M:\\Android_Samples\\android_malware\\Android_benign\\360shoujizhushou\\2017-12-03--2017-12-05\\1bba6a0486ae43e92992ce96191a6ae9059935a5.apk_info\\static.json"
    #data = json.load(open(path))
    #print(feature_vectorization_1(data))
    vectorization_main()